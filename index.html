<!DOCTYPE HTML>
<html>
	<head>
		<title>USSS Capstone - Database and OCR</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper" class="divided">

				<!-- One -->
					<section class="banner style1 orient-left content-align-left image-position-right fullscreen onload-image-fade-in onload-content-fade-right">
						<div class="content">
							<h1>USSS Database OCR Project</h1>
                            <p class="major">The team was challenged to create a databse program capable of ingesting PDF data. use OCR to capture and protocol the data, pair this with a master search bar, and create access control for users to see this data</p>
						</div>
						<div class="image">
							<img src="images/banner.jpg" alt="" />
						</div>
					</section>

				<!-- Two -->
					<section class="spotlight style1 orient-right content-align-left image-position-center onscroll-image-fade-in" id="first">
						<div class="content">
							<h2>Ethan Chandler</h2>
							<p>MSIT, Data Management & Analytics</p>
							<ul class="actions stacked">
								<li><a href="https://www.linkedin.com/in/ethanlchandler/" class="icon brands style2 fa-linkedin-in"></a></li>
							</ul>
						</div>
						<div class="image">
							<img src="images/chandler.png" alt="" />
						</div>
					</section>

				<!-- Three -->
					<section class="spotlight style1 orient-left content-align-left image-position-center onscroll-image-fade-in">
						<div class="content">
							<h2>Jonathan Hobbs</h2>
							<p>MSIT, Cyber Security</p>
							<ul class="actions stacked">
								<li><a href="https://www.linkedin.com/in/jonathanrhobbs/" class="icon brands style2 fa-linkedin-in"></a></li>
							</ul>
						</div>
						<div class="image">
							<img src="images/Hobbs2.jpg" alt="" />
						</div>
					</section>

				<!-- Four -->
					<section class="spotlight style1 orient-right content-align-left image-position-center onscroll-image-fade-in">
						<div class="content">
							<h2>Aswathy Pushpakath</h2>
							<p>MSIT.</p>
							<ul class="actions stacked">
								<li><a href="https://www.linkedin.com/in/aswathy-p-3772141a5/" class="icon brands style2 fa-linkedin-in"></a></li>
							</ul>
						</div>
						<div class="image">
							<img src="images/aswathy.jpg" alt="" />
						</div>
					</section>
				<!-- Five -->
					<section class="spotlight style1 orient-left content-align-left image-position-center onscroll-image-fade-in">
						<div class="content">
							<h2>Kimberly Wright</h2>
							<p>MSIT</p>
							<ul class="actions stacked">
								<li><a href="#" class="icon brands style2 fa-linkedin-in"></a>
                                </li></ul>
						</div>
						<div class="image">
							<img src="images/wright.jpg" alt="" />
						</div>
					</section>
                
				<!-- Six -->
					<section class="spotlight style1 orient-right content-align-left image-position-center onscroll-image-fade-in">
						<div class="content">
							<h2>Lauren Burns</h2>
							<p>MSIT</p>
							<ul class="actions stacked">
								<li><a href="#" class="icon brands style2 fa-linkedin-in"></a></li>
							</ul>
						</div>
						<div class="image">
							<img src="images/spotlight01.jpg" alt="" />
						</div>
					</section>
				<!-- Five -->
					<section class="wrapper style1 align-center">
						<div class="inner">
							<h2>Resources Used</h2>
						</div>

						<!-- Gallery -->
							<div class="gallery style2 medium lightbox onscroll-fade-in">
								<article>
									<a href="images/gallery/thumbs/python.png" class="image">
										<img src="images/gallery/thumbs/python.png" alt="" />
									</a>
								</article>
								<article>
									<a href="images/gallery/thumbs/flask.png" class="image">
										<img src="images/gallery/thumbs/flask.png" alt="" />
									</a>
								</article>
								<article>
									<a href="images/gallery/thumbs/mongodb.png" class="image">
										<img src="images/gallery/thumbs/mongodb.png" alt="" />
									</a>
								</article>
								<article>
									<a href="images/gallery/thumbs/tesseract.png" class="image">
										<img src="images/gallery/thumbs/tesseract.png" alt="" />
									</a>
								</article>
                                <article>
									<a href="images/gallery/thumbs/werkzeug.png" class="image">
										<img src="images/gallery/thumbs/werkzeug.png" alt="" />
									</a>
								</article>
							</div>

					</section>
                
                
                <section class="wrapper style1 align-center">
						<div class="inner">
							<h2>Examples</h2>
							<p>Here are a few examples of the different functionalities working.</p>
							<div class="index align-left">

								<!-- Text -->
									<section>
										<header>
											<h3>Login</h3>
										</header>
										<div class="content">

                                            <div class="iframe-container"><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/qa3yDZiprug" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>

										</div>
									</section>
                                    <!-- Text -->
									<section>
										<header>
											<h3>Upload and Search</h3>
										</header>
										<div class="content">

                                            <div class="iframe-container"><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/2pDRYzDjgTI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>

										</div>
									</section>
                                    <!-- Text -->
									<section>
										<header>
											<h3>Analyst Search</h3>
										</header>
										<div class="content">

                                            <div class="iframe-container"><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/cH_PRdfZeGE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>

										</div>
									</section>
                                    <!-- Text -->
									<section>
										<header>
											<h3>New File with Latest Updates</h3>
										</header>
										<div class="content">

                                            <div class="iframe-container"><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/qgjVk2j-v04" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>

										</div>
									</section>
                                     <!-- Text -->
									<section>
										<header>
											<h3>New User Creation and Hashed Password</h3>
										</header>
										<div class="content">

                                            <div class="iframe-container"><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/hIlrmlJBBLU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>

										</div>
									</section>
                                     <!-- Text -->
									<section>
										<header>
											<h3>User Management</h3>
										</header>
										<div class="content">

                                            <div class="iframe-container"><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/i3DWAKajfsI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>

										</div>
									</section>
                                
                                <!-- code examples -->
                                <section>
										<header>
											<h3>App</h3>
										</header>
										<div class="content">

											<pre><code>import pymongo, os
from flask import Flask, redirect, url_for, request, render_template, flash, session
from pymongo import MongoClient
from werkzeug.utils import secure_filename
from pdf_run import ocr_run
from flask import Flask, render_template
from flask_mongoengine import MongoEngine
from flask_security import Security, MongoEngineUserDatastore, UserMixin, RoleMixin, login_required, logout_user



app = Flask(__name__)


# mongo info for reading
cluster = MongoClient("mongodb+srv://username:password@cluster0-9iib8.mongodb.net/test?retryWrites=true&w=majority")
mc = cluster["Capstone"]
collection = mc["Test"]

# user search
udb = cluster['test']
usercol = udb['Users']

# set locations
UPLOAD_FOLDER = 'Import/'


# app.configs
app = Flask(__name__)
app.config['DEBUG'] = True
app.config['SECRET_KEY'] = 'super-secret'
app.config['SECURITY_REGISTERABLE'] = True
app.config['SECURITY_PASSWORD_SALT'] = 'very secret salt'
app.config['SECURITY_PASSWORD_HASH'] = 'bcrypt'
app.config['SECURITY_SEND_REGISTER_EMAIL'] = False
app.config['MONGODB_SETTINGS'] = {
    'host': 'mongodb+srv://user1:kennesaw@cluster0-9iib8.mongodb.net/test?retryWrites=true&w=majority'
}
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024

#upload doc configuration
ALLOWED_EXTENSIONS = set(['txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif'])


# filename Handler
def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS


# start MongoEngineApp
db = MongoEngine(app)


# User Class Creation
class Role(db.DynamicDocument, RoleMixin):
    # Meta variables.
    meta = {
        'db-alias': 'Capstone',
        'collection': 'Users'
    }
    name = db.StringField(max_length=80, unique=True)
    description = db.StringField(max_length=255)


class User(db.DynamicDocument, UserMixin):
    # Meta variables.
    meta = {
        'db-alias' : 'Capstone',
        'collection': 'Users'
    }
    email = db.StringField(max_length=255)
    password = db.StringField(max_length=255)
    active = db.BooleanField(default=True)
    confirmed_at = db.DateTimeField()
    roles = db.ListField(db.ReferenceField(Role), default=[])


# Setup Flask-Security
user_datastore = MongoEngineUserDatastore(db, User, Role)
security = Security(app, user_datastore)

# Index
@app.route("/")
@login_required
def home():
    return render_template("home.html")

# Search files
@app.route('/search', methods=['POST', 'GET'])
@login_required
def search():
    return render_template('search.html')

# Resultst from search
@app.route('/testresult', methods=['POST', 'GET'])
@login_required
def testresult():
    # If for POST request from search
    if request.method == 'POST':
        field = request.form['field']
        info = request.form['info']
        userquery = {f'{field}': f'{info}'}
        x = []
        cur = collection.find(userquery)
        for i in cur:
            x.append(i)
        return render_template("testresult.html", x=x)
    # If no search return user back to search
    else:
        return render_template('search.html')

# Analyst Search and result route
@app.route('/analystresult', methods=['POST', 'GET'])
@login_required
def analystresult():
    # If Search from analystsearch.html contains data...
    if request.method == 'POST':
        # data from POST request in AnalystSearch
        analyst_query = request.form['analyst_query']
        # Fields to iterate and get a count for each search
        fields = ["SuspectName", "Case", "Date", "CaseAgent", "Analyst", "DOB", "SSN", "DL", "SexRace", "HTWT",
                  "EyesHair", "Misc", "FBIHistory", "Addresses", "Telephones", "Employment", "Vehicles",
                  "RelativesFriends", "Other"]
        # analyst Matrix to hold iterated queries
        am = []
        # field Matrix to ensure results line up in For loop on results page
        fm = []
        for f in fields:
            aq = collection.count({f'{f}': f'{analyst_query}'})
            am.append(aq)
            fm.append(f)
        return render_template("analystresult.html", analyst_query=analyst_query, am=am, fm=fm)
    else:
        return render_template('analystsearch.html')


# Files with latest updates
@app.route('/updates')
@login_required
def updates():
    # Empyt matrix to hold pymongo query
    u = []
    upd = collection.find(sort=[('Date', pymongo.DESCENDING)]).limit(5)
    # Iterate through queries
    for i in upd:
        u.append(i)
    return render_template("updates.html", u=u)


# Show Users
@app.route('/users')
@login_required
def users():
    # User list for iteration
    us = []
    usr = usercol.find(sort=[("email", pymongo.DESCENDING)])
    # Iterate through list to add users from query
    for i in usr:
        us.append(i)
    return render_template("users.html", us=us)


# Upload route
@app.route('/upload')
@login_required
def upload_form():
	return render_template('upload.html')


# Upload case files to Mongodb
@app.route('/', methods=['POST'])
@login_required
def upload_file():
    # Takes Post Request from POST of /upload
    if request.method == 'POST':
        # check if the post request has the files part
        if 'files[]' not in request.files:
            flash('No file part')
            return redirect(request.url)
        files = request.files.getlist('files[]')
        for file in files:
            if file and allowed_file(file.filename):
                filename = secure_filename(file.filename)
                file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))
        flash('File(s) successfully uploaded')
        # pdr_run.py this file has the OCR tesseract
        ocr_run()
        flash('File(s) now on database')
        return redirect('/upload')

# Route for Bad Paths
@app.route('/404')
@login_required
def four_zero_four():
    return render_template('404.html')

# Logout Route takes user to /index for next after logout. Removes cookie.
@app.route("/logout")
@login_required
def logout():
    logout_user()
    return redirect('/index')


if __name__ == "__main__":
    app.secret_key = 'mysecret'
    app.run(debug=True)
</code></pre>

										</div>
									</section>
                                <section>
										<header>
											<h3>OCR</h3>
										</header>
										<div class="content">

											<pre><code>import os
import glob
import pytesseract
from pdf2image import convert_from_path
from PIL import Image
from pymongo import MongoClient

cluster = MongoClient("mongodb+srv://user1:kennesaw@cluster0-9iib8.mongodb.net/test?retryWrites=true&w=majority")

db = cluster["Capstone"]
collection = db["Test"]


def ocr_core(filename):
    custom_oem_psm_config = r'--oem 1 --psm 4'
    text = pytesseract.image_to_string(Image.open(filename), config=custom_oem_psm_config)
    return text

def ocr_run():
    # variable Declarations
    name_area = [1112, 1040, 4104, 1148]
    case_area = [716, 1232, 2628, 1356]
    date_area = [2928, 1240, 4112, 1356]
    agent_area = [728, 1440, 2268, 1556]
    analyst_area = [2700, 1444, 4120, 1560]
    dob_area = [2464, 1668, 3092, 1784]
    ssn_area = [3440, 1672, 4116, 1772]
    dl_area = [2468, 1844, 3376, 1956]
    race_area = [3872, 1828, 4120, 1944]
    height_area = [2548, 2092, 3128, 2192]
    eyes_area = [3672, 2104, 4128, 2200]
    misc_area = [2448, 2284, 4100, 2864]
    fbi_area = [812, 2968, 4116, 3168]
    address_area = [712, 3268, 4116, 3548]
    tel_area = [744, 3624, 4116, 3732]
    emp_area = [788, 3800, 4116, 4012]
    vehicle_area = [640, 4092, 4116, 4360]
    rel_area = [688, 4444, 4116, 4712]
    other_area = [808, 4812, 4116, 5092]

    areas = [name_area, case_area, date_area, agent_area, analyst_area, dob_area, ssn_area, dl_area, race_area, height_area, eyes_area, misc_area, fbi_area, address_area, tel_area, emp_area, vehicle_area, rel_area, other_area]
    images = ["name_image", "case_image", "date_image", "agent_image", "analyst_image", "dob_image", "ssn_image", "dl_image", "race_image", "height_image", "eyes_image", "misc_image", "fbi_image", "address_image", "tel_image", "emp_image", "vehicle_image", "rel_image", "other_image"]
    fields = ["SuspectName", "Case", "Date", "CaseAgent", "Analyst", "DOB", "SSN", "DL", "SexRace", "HTWT", "EyesHair", "Misc", "FBIHistory", "Addresses", "Telephones", "Employment", "Vehicles", "RelativesFriends", "Other"]
    ocrd = {}

    pdf_dir = glob.glob(r'Import/*')
    img_dir = "Images/"

    for pdf_ in pdf_dir:
        ocrd = {}
        pages = convert_from_path(pdf_, 500)
        x = 0
        y = 0
        for page in pages:
            page.save("converted.jpg", 'JPEG')
            for a in areas:
                current_image = page.crop((areas[x]))
                current_image.save("Images/" + str(images[x]) + ".jpg")
                x = x + 1
        for i in range(18):
            ocrd.update({str(fields[y]) : ocr_core('Images/' + str(images[y]) + '.jpg')})
            y = y + 1
        files = glob.glob('Images/*')
        for f in files:
            os.remove(f)
        print(ocrd)
        collection.insert_one(ocrd)
    uploads = glob.glob('Import/*')
    for f in uploads:
        os.remove(f)


</code></pre>

										</div>
									</section>
                        </div>         
                    </div>
                 </section>  

			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>
